{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule â€“ StudyBuddy</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-studybuddy">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
          <img src="{% static 'images/logo.png' %}" alt="??" class="nav-logo">
      </a>
      <a class="navbar-brand" href="{% url 'home' %}">StudyBuddy</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'profile' %}">Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'match_simp' %}">Match</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'chat' %}">Chat</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'requests' %}">Requests</a></li>
          <li class="nav-item"><a class="nav-link active" href="{% url 'schedule' %}">Schedule</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'quiz' %}">Quiz</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'about_m' %}">About</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'index' %}">Logout</a></li>
          <input type="checkbox" class="theme-toggle-input" id="themeToggle" aria-label="Toggle light mode">
          <label for="themeToggle" class="theme-toggle-label">
            <span class="theme-toggle-icon theme-toggle-moon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </svg>
            </span>
            <span class="theme-toggle-slider"></span>
            <span class="theme-toggle-icon theme-toggle-sun" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
              </svg>
            </span>
          </label>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="main-content">
    <div class="container py-4">
      <h1 class="mb-3">AI Suggested Study Schedule</h1>
      {% if profile.subjects %}

        <!-- SUBJECT LIST -->
        <div class="mb-4">
          {% for subject in profile.subjects %}
            <div>
              <h5>{{ subject }}</h5>
              <p>Level: {{ profile.levels|dict_get:subject }}</p>
            </div>
          {% endfor %}
        </div>

        <!-- INPUTS -->
        <div class="card p-3 mb-4">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Start Time</label>
              <input type="time" id="startTime" class="form-control" value="09:00">
            </div>

            <div class="col-md-4">
              <label class="form-label">Break (minutes)</label>
              <input type="number" id="breakTime" class="form-control" value="10">
            </div>

            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-primary w-100" onclick="generateSchedule()">
                Generate
              </button>
            </div>
          </div>
        </div>

        <!-- TABLE -->
        <div class="card p-3">
          <p><strong>Total Study Hours:</strong> {{ profile.study_hours }}</p>

          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Subject</th>
                  <th>Level</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="scheduleBody"></tbody>
            </table>
          </div>
        </div>

      {% else %}
        <div class="alert alert-info">
          No subjects added in profile.
        </div>
      {% endif %}
    </div>
  </main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- PASS DATA TO JS -->
  {{ profile.subjects|json_script:"subjects-data" }}
  {{ profile.levels|json_script:"levels-data" }}
  {{ profile.study_hours|json_script:"hours-data" }}

<script>
const SUBJECTS = JSON.parse(document.getElementById("subjects-data").textContent);
const LEVELS = JSON.parse(document.getElementById("levels-data").textContent);
const TOTAL_HOURS = JSON.parse(document.getElementById("hours-data").textContent);

function addMinutes(time, mins) {
  const [h, m] = time.split(":").map(Number);
  const date = new Date();
  date.setHours(h);
  date.setMinutes(m + mins);
  return date.toTimeString().slice(0,5);
}

function generateSchedule() {
  const start = document.getElementById("startTime").value;
  const breakMins = parseInt(document.getElementById("breakTime").value);

  const body = document.getElementById("scheduleBody");
  body.innerHTML = "";

  let currentTime = start;
  let totalMinutes = TOTAL_HOURS * 60;
  const session = 45;

  let i = 0;

  while (totalMinutes > session && SUBJECTS.length > 0) {
    const subject = SUBJECTS[i % SUBJECTS.length];
    const level = LEVELS[subject] || "Beginner";

    const end = addMinutes(currentTime, session);

    body.innerHTML += `
      <tr>
        <td>${subject}</td>
        <td>${level}</td>
        <td>${currentTime} - ${end}</td>
      </tr>
    `;

    totalMinutes -= session;
    currentTime = addMinutes(end, breakMins);
    totalMinutes -= breakMins;
    i++;
  }
}

</script>
<script>
/* StudyBuddy theme */
(function(g){'use strict';var K='studybuddy_theme';function getTheme(){try{var s=localStorage.getItem(K);return s==='light'||s==='dark'?s:'dark';}catch(e){return 'dark';}}
function setTheme(t){t=t==='light'?'light':'dark';try{localStorage.setItem(K,t);}catch(e){}document.documentElement.setAttribute('data-theme',t);var i=document.getElementById('themeToggle');if(i)i.checked=(t==='light');}
function init(){var t=getTheme();document.documentElement.setAttribute('data-theme',t);var i=document.getElementById('themeToggle');if(i){i.checked=(t==='light');i.addEventListener('change',function(){setTheme(i.checked?'light':'dark');});}}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();g.StudyBuddyTheme={getTheme:getTheme,setTheme:setTheme,init:init};})(typeof window!=='undefined'?window:this);
  </script>
</body>
</html>
